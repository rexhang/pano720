<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- for optimal display on high DPI devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ™¯ç…§ç‰‡é¢„è§ˆ | åŠ è½½ä¸­...</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/compass-plugin@5/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/settings-plugin@5/index.css" />
  <style>
    html,
    body,
    #viewer {
      width: 100vw;
      height: 100vh;
      margin: 0;
      font-family: sans-serif;
      /* overflow: hidden; */
    }
    .psv-navbar {
      width: 88%;
      left: 6%;
      height: 50px;
      bottom: -50px;
      align-items: center;
      background: transparent;
    }
    .psv-navbar--open {
      /* bottom: calc(0px + constant(safe-area-inset-bottom)); */
      /* bottom: calc(0px + env(safe-area-inset-bottom)); */
      bottom: 0;
    }
    .psv-caption {
      text-align: left;
    }
  </style>
</head>

<div id="viewer" style="width: 100vw; height: 100vh;"></div>

<script type="importmap" >
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
      "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.module.js",
      "@photo-sphere-viewer/compass-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/compass-plugin@5/index.module.js",
      "@photo-sphere-viewer/gyroscope-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gyroscope-plugin@5/index.module.js",
      "@photo-sphere-viewer/settings-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/settings-plugin@5/index.module.js",
      "@photo-sphere-viewer/resolution-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/resolution-plugin@5/index.module.js"
    }
  }
</script>

<script type="module">
  import { Viewer, utils } from '@photo-sphere-viewer/core';
  // import { AutorotatePlugin } from '@photo-sphere-viewer/autorotate-plugin'; // éœ€è¦importæ’ä»¶å…ˆ.
  import { CompassPlugin } from '@photo-sphere-viewer/compass-plugin';
  import { GyroscopePlugin } from '@photo-sphere-viewer/gyroscope-plugin';
  import { SettingsPlugin } from '@photo-sphere-viewer/settings-plugin';
  import { ResolutionPlugin } from '@photo-sphere-viewer/resolution-plugin';

  // é…ç½®ä¿¡æ¯: name å°½é‡ä¸è¦è¶…è¿‡10ä¸ªå­—ç¬¦
  const PANO_CONF = {
    '1': {
      name: 'è‹å·-åŒç¨‹æ—…è¡Œå¤§å¦',
      dir: 'DJI_0022.JPG',
      dirSmall: "DJI_0022_SMALL.JPG"
    },
    '2': {
      name: 'è‹å·-çŸ³æ¹–æ™¯åŒº',
      dir: 'DJI_0028.JPG',
      dirSmall: "DJI_0028_SMALL.JPG"
    },
    '3': {
      name: 'è‹å·-æ·æ³½å®¶å›­',
      dir: 'DJI_0040.JPG',
      dirSmall: "DJI_0040_SMALL.JPG"
    }
  }

  const urlSearchParams = new URLSearchParams(location.search);

  const pageId = urlSearchParams.get('id');

  const CURRENT_PANO_CONF = PANO_CONF[pageId];

  // æ›´æ”¹id=ä¸ç¬¦åˆè§„å®šèŒƒå›´å†…çš„id é‡å®šå‘åˆ°æŸä¸ªid
  function replaceQueryParamAndReload(param, newValue) {
    // åˆ›å»ºå½“å‰URLçš„URLå¯¹è±¡
    const currentUrl = new URL(window.location);

    // ä½¿ç”¨URLSearchParamsæ¥è§£æå’Œä¿®æ”¹æŸ¥è¯¢å­—ç¬¦ä¸²
    currentUrl.searchParams.set(param, newValue);

    // è®¾ç½®ä¿®æ”¹åçš„URLï¼Œè§¦å‘é¡µé¢é‡è½½
    // window.location.href = currentUrl.toString();
    window.location.replace(currentUrl.toString())
  }

  if (!CURRENT_PANO_CONF) {
    replaceQueryParamAndReload('id', 1); // ä¸å­˜åœ¨çš„idï¼Œå‰å¾€ç¬¬ä¸€ä¸ªä½œä¸ºå…œåº•ã€‚
  }

  document.title = `å…¨æ™¯ç…§ç‰‡é¢„è§ˆ | ${CURRENT_PANO_CONF.name}`;

  const baseUrl = './src/img/';

  const animatedValues = {
    pitch: { start: -Math.PI / 2, end: 0 },
    yaw: { start: Math.PI / 2, end: 0 },
    zoom: { start: 0, end: 50 },
    maxFov: { start: 130, end: 90 },
    fisheye: { start: 2, end: 0 },
  };

  const viewer = new Viewer({
    container: 'viewer',
    // panorama: baseUrl + CURRENT_PANO_CONF.dir,
    // caption: CURRENT_PANO_CONF.name + '<b style="font-size: 10px;">power by @rexhang.airport</b>',
    caption: '<b style="font-size: 10px;">author@rexhang.airport</b>',
    loadingImg: baseUrl + 'rexhang-icon.png',
    defaultPitch: animatedValues.pitch.start,
    defaultYaw: animatedValues.yaw.start,
    defaultZoomLvl: animatedValues.zoom.start,
    maxFov: animatedValues.maxFov.start,
    fisheye: animatedValues.fisheye.start,
    mousemove: false,
    mousewheel: false,
    lang: {
      resolution: 'æ¸…æ™°åº¦',
    },
    navbar: [
      // 'autorotate',
      // 'zoom',
      // {
      //   title: 'Rerun animation',
      //   content: 'ğŸ”„',
      //   onClick: reset,
      // },

      // æ ‡é¢˜
      'caption',
      // é™€èºä»ª
      'gyroscope',
      // è®¾ç½®
      'settings',
      // å…¨å±
      'fullscreen',
    ],
    plugins: [
      // è®¾ç½®æ’ä»¶
      SettingsPlugin,
      // è§£æåº¦é¢„åŠ è½½æ’ä»¶
      [ResolutionPlugin, {
        defaultResolution: 'æ™®æ¸…',
        resolutions: [
          {
              id: 'æ™®æ¸…',
              label: 'æ™®æ¸…',
              panorama: baseUrl + CURRENT_PANO_CONF.dirSmall,
          },
          {
              id: 'é«˜æ¸…',
              label: 'é«˜æ¸…',
              panorama: baseUrl + CURRENT_PANO_CONF.dir,
          },
        ],
      }],
      // é™€èºä»ªæ’ä»¶
      [GyroscopePlugin, {
        absolutePosition: false,
        roll: true,
        moveMode: 'fast', // 'smooth'
        touchmove: true,
      }],
      // è‡ªåŠ¨æ—‹è½¬æ’ä»¶
      /* [AutorotatePlugin, {
        autostartDelay: null,
        autostartOnIdle: false,
        autorotatePitch: 0,
      }], */
      // æŒ‡å—é’ˆæ’ä»¶
      [CompassPlugin, {
        size: '60px',
        // coneColor: 'rgba(255, 255, 255, 0.5)', // éè§¦æ‘¸æ—¶å€™çš„æ‰‡åŒºé¢œè‰²
        // hotspotColor: 'rgba(255, 255, 255, 0.5)', æ–¹ä½ç‚¹çš„é¢œè‰²
        // navigationColor: 'rgba(255, 0, 0, 0.2)', // è§¦æ‘¸æ—¶å€™çš„æ‰‡åŒºé¢œè‰²
        hotspots: [
            { yaw: '0deg' },
            { yaw: '90deg' },
            { yaw: '180deg' },
            { yaw: '270deg' },
        ],
      }],
    ],
  });

  // const autorotate = viewer.getPlugin(AutorotatePlugin);

  let isInit = true;

  const delayStart = 300; // å»¶è¿Ÿæ—¶é—´ms

  // setup timer for automatic animation on startup
  viewer.addEventListener('ready', () => {
    viewer.navbar.hide();
    if (delayStart) {
      setTimeout(() => {
        if (isInit) {
          intro(animatedValues.pitch.end, animatedValues.pitch.end);
        }
      }, delayStart);
    } else {
      if (isInit) {
        intro(animatedValues.pitch.end, animatedValues.pitch.end);
      }
    }
  }, { once: true });

  // launch animation to clicked point
  viewer.addEventListener('click', ({ data }) => {
    if (isInit) {
      intro(data.pitch, data.yaw);
    }
  });

  // perform the intro animation
  function intro(pitch, yaw) {
    isInit = false;
    // autorotate.stop();
    viewer.navbar.hide();

    new utils.Animation({
      properties: {
        ...animatedValues,
        pitch: { start: animatedValues.pitch.start, end: pitch },
        yaw: { start: animatedValues.yaw.start, end: yaw },
      },
      duration: 2500,
      easing: 'inOutQuad',
      onTick: (properties) => {
        viewer.setOptions({
          fisheye: properties.fisheye,
          maxFov: properties.maxFov,
        });
        viewer.rotate({ yaw: properties.yaw, pitch: properties.pitch });
        viewer.zoom(properties.zoom);
      },
    }).then(() => {
      // autorotate.start();
      viewer.navbar.show();
      viewer.setOptions({
        mousemove: true,
        mousewheel: true,
      });
    });
  }

  // perform the reverse animation
  function reset() {
    isInit = true;
    // autorotate.stop();
    viewer.navbar.hide();
    viewer.setOptions({
      mousemove: false,
      mousewheel: false,
    });

    new utils.Animation({
      properties: {
        pitch: { start: viewer.getPosition().pitch, end: animatedValues.pitch.start },
        yaw: { start: viewer.getPosition().yaw, end: animatedValues.yaw.start },
        zoom: { start: viewer.getZoomLevel(), end: animatedValues.zoom.start },
        maxFov: { start: animatedValues.maxFov.end, end: animatedValues.maxFov.start },
        fisheye: { start: animatedValues.fisheye.end, end: animatedValues.fisheye.start },
      },
      duration: 1500,
      easing: 'inOutQuad',
      onTick: (properties) => {
        viewer.setOptions({
          fisheye: properties.fisheye,
          maxFov: properties.maxFov,
        });
        viewer.rotate({ yaw: properties.yaw, pitch: properties.pitch });
        viewer.zoom(properties.zoom);
      },
    });
  }

  window.viewer = viewer;

</script>

<body>

</body>

</html>
